version: "3.8"

services:
  # 1. Database (PostgreSQL)
  db:
    image: postgres:16-alpine
    container_name: meeting_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASS:-postgres}
      POSTGRES_DB: ${DB_NAME:-meeting_assistant}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - meeting-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Object Storage (MinIO - S3 Compatible)
  minio:
    image: minio/minio:latest
    container_name: meeting_minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000" # API Port
      - "9001:9001" # Console Port
    environment:
      MINIO_ROOT_USER: ${STORAGE_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${STORAGE_SECRET_KEY:-minioadmin}
    volumes:
      - minio_data:/data
    networks:
      - meeting-net

  # 3. MinIO Configurator (Creates buckets automatically)
  # This is a "Job" container. It runs once to set up the bucket, then dies.
  createbuckets:
    image: minio/mc:latest
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for MinIO to be ready...';
      for i in 1 2 3 4 5 6 7 8 9 10; do
        if /usr/bin/mc alias set myminio http://minio:9000 ${STORAGE_ACCESS_KEY:-minioadmin} ${STORAGE_SECRET_KEY:-minioadmin} 2>/dev/null; then
          echo 'MinIO is ready, creating bucket...';
          /usr/bin/mc mb myminio/${STORAGE_BUCKET:-meeting-assistant} || true;
          /usr/bin/mc anonymous set public myminio/${STORAGE_BUCKET:-meeting-assistant};
          echo 'Bucket created successfully';
          exit 0;
        fi;
        echo 'MinIO not ready yet, waiting... (attempt $i/10)';
        sleep 2;
      done;
      echo 'Failed to connect to MinIO after 10 attempts';
      exit 1;
      "
    networks:
      - meeting-net

  # 4. Redis (Queue & Caching)
  redis:
    image: redis:7-alpine
    container_name: meeting_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - meeting-net

volumes:
  postgres_data:
  minio_data:
  redis_data:

networks:
  meeting-net:
    driver: bridge
